<!DOCTYPE html>
<html>
    <head>
        <title>DeepaMehta Image Browser</title>
        <meta charset="UTF-8" />
        <link rel="stylesheet" href="/de.deepamehta.images/style/styles.css" type="text/css" />
        <script type="text/javascript">
        // CKEditor image browse integration, see CKEDITOR.config.filebrowserImageBrowseUrl

            function showImages($, dm4c, ck) {
                var funcNum = getUrlParam('CKEditorFuncNum')
                var images = dm4c.restc.request('GET', '/images/browse')
                var $body = $(document.body)
                var $listButton = $('<span>').addClass('listview').text('List view')
                    $listButton.click(function (e) {
                        switchToListLayout();
                    })
                var $previewButton = $('<span>').addClass('imageview').addClass('current').text('Image view')
                    $previewButton.click(function (e) {
                        switchToPreviewLayout();
                    })
                var $ul = $('<ul>')
                $.each(images, function (i, image) {
                    var bytesize = Math.round(image.size / 1000)
                    var $img = $('<img>').attr('src', image.src)
                        $img.attr('title', 'Choose "' + image.name + '", ' + bytesize + ' KByte')
                    var $fileName = $('<span class="name">').text(image.name)
                    var $fileSize = $('<span class="size">').text(bytesize + ' KByte')
                    var $fileType = $('<span class="type">').text(image.type)
                    var $item = $('<li>').append($img).append('<br/>')
                        .append($fileName).append($fileSize).append($fileType)
                    $ul.append($item)
                })
                $body.append($previewButton).append($listButton).append('<br/>')
                $body.append($ul)
                $body.on('click', 'li', function () {
                    ck.tools.callFunction(funcNum, $('img', this).attr('src'))
                    window.close()
                })

                function switchToListLayout() {
                    $body.addClass('list')
                    $previewButton.removeClass('current')
                    $listButton.addClass('current')
                }

                function switchToPreviewLayout() {
                    $body.removeClass('list')
                    $previewButton.addClass('current')
                    $listButton.removeClass('current')
                }
            }

        // TODO js_utils should include this method
            function getUrlParam(param) {
                var regex = new RegExp('(?:[\?&]|&amp;)' + param + '=([^&]+)', 'i')
                var match = window.location.search.match(regex)
                return (match && match.length > 1) ? match[1] : ''
            }

        </script>
    </head>
    
    <body class="image-browser" 
          onload="showImages(window.opener.jQuery, window.opener.dm4c, window.opener.CKEDITOR)">
    </body>
</html>
